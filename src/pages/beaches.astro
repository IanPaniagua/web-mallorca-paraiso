---
import Layout from '../layouts/Layout.astro';
import BeachesSidebar from '../components/BeachesSidebar';
import type { Beach, BeachFilters } from '../api/types/beach.types';
import { API_ENDPOINTS } from '../config/api';
import { fetchFromBackend } from '../utils/api';

// Fetch data at build time (equivalent to getStaticProps)
const beaches = await fetchFromBackend<Beach[]>(API_ENDPOINTS.beaches.getAll);

// Extract unique zones, localities and categories from the data
const regions = [...new Set(beaches.map(beach => beach.locality.zone.name))];
const towns = [...new Set(beaches.map(beach => beach.locality.name))];
const types = [...new Set(beaches.map(beach => beach.category))];

// Generate metadata for SEO
const title = "Playas de Mallorca - Calas y Playas Paradis√≠acas";
const description = "Descubre los rincones m√°s paradis√≠acos de la costa mallorquina. Encuentra informaci√≥n detallada sobre las mejores playas y calas de Mallorca.";
---

<Layout title={title}>
  <head slot="head">
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
  </head>

  <div slot="header">
    <div class="py-2">
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-display bg-gradient-to-r from-[#0066FF] to-[#00D4FF] bg-clip-text text-transparent mb-4">
        Playas y Calas
      </h1>
      <p class="text-base sm:text-lg text-gray-600 max-w-2xl mx-auto">
        Descubre los rincones m√°s paradis√≠acos de la costa mallorquina.
      </p>
    </div>
  </div>

  <script define:vars={{ regions, towns, types }}>
    // Function to filter beaches
    function filterBeaches(filters) {
      const articles = document.querySelectorAll('#beachesGrid article');
      
      articles.forEach(article => {
        const region = article.dataset.region;
        const town = article.dataset.town;
        const type = article.dataset.type;
        const name = article.dataset.name;
        
        const matchesSearch = !filters.search || 
          name.toLowerCase().includes(filters.search.toLowerCase());
        
        const matchesRegion = !filters.region || 
          region === filters.region;
        
        const matchesTown = !filters.town || 
          town === filters.town;
        
        const matchesType = !filters.type || 
          type === filters.type;
        
        const isVisible = matchesSearch && matchesRegion && 
          matchesTown && matchesType;
        
        article.style.display = isVisible ? 'flex' : 'none';
      });
    }

    // Initialize filters when page loads
    document.addEventListener('DOMContentLoaded', () => {
      filterBeaches({ search: '', region: '', town: '', type: '' });
    });
  </script>

  <div class="flex">
    <BeachesSidebar 
      client:load
      regions={regions}
      towns={towns}
      types={types}
    />
    <div id="beachesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-1 p-6">
      {beaches.map((beach) => (
        <article 
          class="bg-white rounded-lg shadow-sm overflow-hidden flex flex-col"
          data-region={beach.locality.zone.name}
          data-town={beach.locality.name}
          data-type={beach.category}
          data-name={beach.name.toLowerCase()}
        >
          <div class="relative">
            <img 
              src={beach.image || 'https://mallorca-paraiso-web.s3.eu-central-1.amazonaws.com/beach.jpg'} 
              alt={`Playa ${beach.name}`}
              class="w-full h-48 object-cover"
              loading="lazy"
              onerror="this.src='https://mallorca-paraiso-web.s3.eu-central-1.amazonaws.com/beach.jpg'; this.onerror=null;"
            />
            {beach.featured && (
              <span class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 text-xs px-2 py-1 rounded-full">
                Destacada
              </span>
            )}
          </div>
          <div class="p-4">
            <h3 class="text-xl font-display bg-gradient-to-r from-[#0066FF] to-[#00D4FF] bg-clip-text text-transparent mb-2">
              {beach.name}
            </h3>
            <p class="text-gray-600 mb-4">{beach.description}</p>
            <div class="space-y-2 text-sm text-gray-600">
              <p class="flex items-center gap-2">
                <span class="text-[#0066FF]">üìç</span>
                {beach.locality.name}, {beach.locality.zone.name}
              </p>
              <p class="flex items-center gap-2">
                <span class="text-[#0066FF]">üèñÔ∏è</span>
                {beach.category} ({beach.type})
              </p>
              <p class="flex items-center gap-2">
                <span class="text-[#0066FF]">üöó</span>
                {beach.access}
              </p>
              <a 
                href={`https://www.google.com/maps?q=${beach.latitude},${beach.longitude}`}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 text-[#0066FF] hover:text-[#00D4FF] transition-colors"
              >
                <span>üó∫Ô∏è</span>
                C√≥mo llegar
              </a>
            </div>
            <div class="mt-4">
              <h4 class="text-sm font-semibold text-gray-500 mb-2">Servicios</h4>
              <div class="flex flex-wrap gap-2">
                {beach.services.map(service => (
                  <span class="bg-gradient-to-r from-[#0066FF]/10 to-[#00D4FF]/10 text-[#0066FF] px-3 py-1 rounded-full text-sm">
                    {service}
                  </span>
                ))}
              </div>
            </div>
          </div>
        </article>
      ))}
    </div>
  </div>

  <section class="bg-gradient-to-b from-[#0066FF]/20 to-[#00D4FF]/20 py-12 px-4 rounded-lg mb-12">
    <div class="max-w-3xl mx-auto text-center">
      <h2 class="text-3xl font-display bg-gradient-to-r from-[#0066FF] to-[#00D4FF] bg-clip-text text-transparent mb-6">
        Consejos para tu visita
      </h2>
      <div class="grid md:grid-cols-3 gap-6">
        <div>
          <div class="text-2xl mb-2">üåä</div>
          <h3 class="font-display text-lg mb-2">Mejor temporada</h3>
          <p class="text-gray-600">Mayo a Octubre son los meses ideales para disfrutar del mar</p>
        </div>
        <div>
          <div class="text-2xl mb-2">üß¥</div>
          <h3 class="font-display text-lg mb-2">Protecci√≥n</h3>
          <p class="text-gray-600">No olvides protector solar y sombrilla en las calas sin servicios</p>
        </div>
        <div>
          <div class="text-2xl mb-2">‚è∞</div>
          <h3 class="font-display text-lg mb-2">Horario</h3>
          <p class="text-gray-600">Visita temprano para encontrar mejor parking y menos gente</p>
        </div>
      </div>
    </div>
  </section>
</Layout>

